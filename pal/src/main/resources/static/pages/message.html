
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>消息界面</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link rel="stylesheet" type="text/css" href="css/animate.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/line-awesome.css">
		<link rel="stylesheet" type="text/css" href="css/line-awesome-font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
		<link rel="stylesheet" type="text/css" href="css/jquery.mCustomScrollbar.min.css">
		<link rel="stylesheet" type="text/css" href="lib/slick/slick.css">
		<link rel="stylesheet" type="text/css" href="lib/slick/slick-theme.css">
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<link rel="stylesheet" type="text/css" href="css/responsive.css">
	</head>


	<body>
		

		<div class="wrapper" id="app">
			

	<!-- 头部--------------------start -->
				<header>
					<div class="container">
						<div class="header-data">
							<div class="logo">
								<a href="index.html" title=""><img src="images/logo.png" alt=""></a>
							</div><!--logo end-->
							<div class="search-bar">
							
							</div><!--search-bar end-->
							<nav>
								<ul>
									<li>
										<a href="profile.html" title="">
											<span><img src="images/icon4.png" alt=""></span>
											{{topLabel[0]}}
										</a>
									</li>
									
									<li>
										<a href="#" title="" class="not-box-open">
											<span><img src="images/icon6.png" alt=""></span>
											{{topLabel[1]}}
										</a>
									</li>
									<li>
										<a @click="logout" title="" class="not-box-open">
											<span><img src="images/icon7.png" alt=""></span>
											{{topLabel[2]}}
										</a>
									</li>
								</ul>
							</nav><!--nav end-->
							<div class="menu-btn">
								<a href="#" title=""><i class="fa fa-bars"></i></a>
							</div><!--menu-btn end-->
							<div class="user-account">
								<div class="user-info" style="width: 150px;">
									<select style="background: #E44D3A;border: none;color: white;" 
									class="form-control form-control-lg language" v-model="languageID" @click="change">
										<option selected="true" value="1">中文简体</option>
										<option value="2">中文-繁體</option>
										<option value="3">English</option>
										<option value="4">한국어</option>
										<option value="5">にほんご</option>
										<option value="6">ภาษาไทย</option>
									</select>
								</div>
							</div>
						</div><!--header-data end-->
					</div>
				</header><!--header end-->	
				<!-- 头部--------------------end -->



			<section class="messages-page">
				<div class="container">
					<div class="messages-sec">
						<div class="row">
							<div class="col-lg-4 col-md-12 no-pdd" style="background: #FFFFFF;">
								<div class="msgs-list">
									<div class="msg-title">
										<h3>Messages</h3>
									</div><!--msg-title end-->

									<div class="messages-list">
										<ul>
											<li v-for="(item, index) in linkMan" @click="toDetailView(index)" :id="index" v-bind:class="{ active: (index == indexTemp) }">
												<div class="usr-msg-details">
													<div class="usr-ms-img">
														<template v-if="item.view.user.headStatus == 1">
															<img :src="headLink" alt="">
														</template>
														<template v-else>
															<img :src="item.view.user.headLink" alt="">
														</template>
														<template v-if="item.view.count > 0">
															<span class="msg-status"></span>
														</template>
													</div>
													<div class="usr-mg-info">
														<h3>{{item.view.user.username}}</h3>
													</div><!--usr-mg-info end-->
													<template v-if="item.view.count > 0">
														<span class="msg-notifc">{{item.view.count}}</span>
													</template>
												</div><!--usr-msg-details end-->
											</li>
											
										</ul>
									</div><!--messages-list end-->
								</div><!--msgs-list end-->
							</div>
							<div class="col-lg-8 col-md-12 pd-right-none pd-left-none">
								<div class="main-conversation-box">
									<div class="messages-line mCustomScrollbar _mCS_1" >
										<div id="mCSB_1" class="mCustomScrollBox mCS-light mCSB_vertical mCSB_inside" style="max-height: none;" tabindex="0">
											<div id="mCSB_1_container" class="mCSB_container" style="position:relative; top:0; left:0;padding-top:20px;" dir="ltr">
												<template v-for="(item, index) in message">
													<div class="main-message-box ta-right" v-if="item.view.flag == true">
														<div class="message-dt">
															<div class="message-inner-dt">
																<p>{{item.view.message.content}}</p>
															</div>
															<span>{{item.view.createDate}}</span>
														</div>
														<div class="messg-usr-img">
															<template v-if="item.view.user.headStatus==1">
																<img :src="headLink" alt="" class="mCS_img_loaded">
															</template>
															<template v-else>
																<img :src="item.view.user.headLink" class="mCS_img_loaded">
															</template>
														</div>
													</div>
													
													<div class="main-message-box st3" v-else>
														<div class="message-dt st3">
															<div class="message-inner-dt">
																<p>{{item.view.message.content}}</p>
															</div>
															<span>{{item.view.createDate}}</span>
														</div>
														<div class="messg-usr-img">
															<template v-if="item.view.user.headStatus==1">
																<img :src="headLink" alt="" class="mCS_img_loaded">
															</template>
															<template v-else>
																<img :src="item.view.user.headLink" class="mCS_img_loaded">
															</template>
														</div>
													</div>
												</template>							
																		
											</div>
											<div id="mCSB_1_scrollbar_vertical" class="mCSB_scrollTools mCSB_1_scrollbar mCS-light mCSB_scrollTools_vertical" style="display: block;">
												<div class="mCSB_draggerContainer">
													<div id="mCSB_1_dragger_vertical" class="mCSB_dragger" style="position: absolute; min-height: 30px; display: block; height: 367px; max-height: 594px; top: 0px;">
														<div class="mCSB_dragger_bar" style="line-height: 30px;"></div>
													</div>
													<div class="mCSB_draggerRail"></div>
												</div>
											</div>
										</div>
									</div>
									
									<div class="message-send-area">
										<form>
											<div class="mf-field">
												<input type="text" name="message" v-model="content" placeholder="Type a message here">
												<a @click="sendMessage" class="btn btn-danger"  style="margin-left: 15px;">Send</a>
											</div>
										</form>
									</div><!--message-send-area end-->
								</div><!--main-conversation-box end-->
							</div>
						</div>
					</div><!--messages-sec end-->
				</div>
			</section><!--messages-page end-->



			<footer>
				<div class="footy-sec mn no-margin">
					<div class="container">
						<ul>
							<li><a href="#" title="">Help Center</a></li>
							<li><a href="#" title="">Privacy Policy</a></li>
							<li><a href="#" title="">Community Guidelines</a></li>
							<li><a href="#" title="">Cookies Policy</a></li>
							<li><a href="#" title="">Career</a></li>
							<li><a href="#" title="">Forum</a></li>
							<li><a href="#" title="">Language</a></li>
							<li><a href="#" title="">Copyright Policy</a></li>
						</ul>
						<p><img src="images/copy-icon2.png" alt="">Copyright 2017</p>
						<img class="fl-rgt" src="images/logo2.png" alt="">
					</div>
				</div>
			</footer>

		</div><!--theme-layout end-->
	</body>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/popper.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript" src="js/jquery.mCustomScrollbar.js"></script>
	<script type="text/javascript" src="lib/slick/slick.min.js"></script>
	<script type="text/javascript" src="js/scrollbar.js"></script>
	<script type="text/javascript" src="js/script.js"></script>
	<script src="js/vue-2.4.0.js"></script>
	<script src="js/vue-resource-1.3.4.js"></script>
	<script>
		var vm = new Vue({
			el : '#app',
			data:{
				headLink:"images/user/default.png",
				linkMan:[],
				indexTemp:0,
				userID:0,
				message:[],
				timer:"",
				linkTimer:"",
				//发送消息
				content:"",
				
				languageID:1,
				topLabel:["个人资料", "消息", "退出"]
			},
			methods:{
				checkTicket() {
					this.ticket = localStorage.getItem("ticket");
					if(this.ticket == "") {
						window.location.href = "login.html"
						return 
					}
					this.clearLinkTimer()
					this.clearTimer()
				},
				//跳转到登录页面
				toLoginView(res) {
					if(res.body.code == "302") {
						window.location.href = "login.html"
					}
				},
				//分页获取所有的汉服
				getLinkman() {
					this.$http.get('/user/getLinkman/',
					{params : {time:new Date().getTime()}})
					.then(function(res){
						this.toLoginView(res)
						this.linkMan = res.body.data
					},function() {
						console.log('请求失败处理');
					});
				},
				toDetailView(index){
					this.indexTemp = index
					this.linkMan[index].view.count = 0
					this.userID = this.linkMan[index].view.user.id
					this.clearTimer()
					this.getMessageDetail()
					this.createTimer()
				},
				getMessageDetail() {
					this.$http.get('/user/getMessageDetail/',
					{params : {time:new Date().getTime(), userID:this.userID}})
					.then(function(res){
						this.toLoginView(res)
						this.message = res.body.data
					},function() {
						console.log('请求失败处理');
					});
				},
				//添加消息
				sendMessage(){
					if(this.content == "" || this.userID == 0) {
						return ;
					}
					var formData = new FormData();
					formData.append('content', this.content);
					formData.append('toUserID', this.userID);
					this.$http.post('/user/addMessage/', formData).
					then(function (res) {
						this.toLoginView(res)
						this.content = ""
					}, function (res) {
					  console.log(res.body);
					});
				},
				clearLinkTimer(){
					clearInterval(this.linkTimer)
				},
				clearTimer(){
					clearInterval(this.timer)
				},
				createLinkTimer(){
					linkTimer = setInterval(this.getLinkman, 2000)
				},
				createTimer() {
					timer = setInterval(this.getMessageDetail, 2000)
				},
				logout(){
					this.$http.get('/user/logout/',
						{params : {time:new Date().getTime()}})
					.then(function(res) {
						window.location.href = "login.html"
					},function() {
						console.log('请求失败处理');
					});
				},
				change() {
					if(this.languageID == 1) {
						this.topLabel = ["个人资料", "消息", "退出"]
					} else if(this.languageID == 2) {
						this.topLabel = ["個人資料", "消息", "退出"]
					} else if(this.languageID == 3) {
						this.topLabel = ["personal data", "message", "log out"]
					} else if(this.languageID == 4) {
						this.topLabel = ["인적 사항", "소식.정보.", "퇴출"]
					} else if(this.languageID == 5) {
						this.topLabel = ["个人资料", "しょうそく", "たいしゅつ"]
					} else if(this.languageID == 6) {
						this.topLabel = ["ข้อมูลส่วนบุคคล", "ข่าว", "ออก"]
					}
				}
			},
			mounted() {
				this.createLinkTimer()
			},
			beforeMount() {
				this.getLinkman()
			},
			beforeDestroy() {
				this.checkTicket()
			}
		})
	</script>
</html>
